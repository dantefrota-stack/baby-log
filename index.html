<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Baby Log Final</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8.3.0/framework7-bundle.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7-icons/css/framework7-icons.css">

    <style>
        /* === GLOBAL LAYOUT === */
        body { 
            margin: 0; padding: 0; background-color: #eef2f6; 
            font-family: -apple-system, system-ui, Helvetica, Arial, sans-serif;
            height: 100vh; display: flex; justify-content: center;
        }

        /* Center the App on Desktop */
        #app-frame {
            width: 100%; max-width: 450px; height: 100vh;
            background: #fff; position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        @media (min-width: 768px) {
            #app-frame { height: 95vh; margin-top: 2.5vh; border-radius: 20px; border: 1px solid #ccc; overflow: hidden; }
        }

        /* === HEADER === */
        .navbar {
            background: #fff; padding: 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .nav-title { font-weight: 800; font-size: 18px; color: #333; }
        .date-btn {
            background: #f5f5f5; border: 1px solid #ddd; padding: 6px 12px; border-radius: 8px;
            font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; cursor: pointer;
        }
        
        /* === SCROLL AREA === */
        .content {
            flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa;
            padding-bottom: 100px; /* Space for footer */
        }

        /* === CARDS === */
        .card {
            background: #fff; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eee; overflow: hidden;
        }
        .card-header {
            background: #fafafa; padding: 10px 15px; border-bottom: 1px solid #f0f0f0;
            font-size: 12px; font-weight: 800; text-transform: uppercase; color: #555;
            display: flex; align-items: center; gap: 8px;
        }

        /* === INPUTS === */
        .input-row { display: flex; align-items: center; padding: 10px; gap: 8px; }
        
        .input-box {
            flex: 1; display: flex; border: 1px solid #ddd; border-radius: 8px;
            background: #fff; overflow: hidden; align-items: center;
        }
        .input-box input, .input-box select {
            border: none; height: 40px; padding: 0 10px; font-size: 16px; width: 100%; background: transparent; outline: none;
        }
        .input-divider { width: 1px; height: 24px; background: #eee; }
        .input-time { width: 90px; text-align: center; color: #555; font-size: 14px; }

        /* Add Button */
        .btn-add {
            width: 44px; height: 40px; border: none; border-radius: 8px;
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-add:active { transform: scale(0.95); }

        /* Colors */
        .c-blue { color: #007aff; } .bg-blue { background: #007aff; }
        .c-green { color: #34c759; } .bg-green { background: #34c759; }
        .c-orange { color: #ff9500; } .bg-orange { background: #ff9500; }
        .c-pink { color: #ff2d55; } .bg-pink { background: #ff2d55; }

        /* === HISTORY LIST === */
        .list-box { border-top: 1px solid #f5f5f5; }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-bottom: 1px solid #f9f9f9; animation: fade 0.2s;
        }
        .list-item:last-child { border-bottom: none; }
        @keyframes fade { from { opacity:0; } to { opacity:1; } }

        .item-time { font-family: monospace; font-weight: 600; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-right: 8px; font-size: 12px; }
        .item-text { font-size: 15px; color: #333; font-weight: 500; }
        .item-del { color: #ff3b30; padding: 5px; cursor: pointer; opacity: 0.4; }
        .item-del:hover { opacity: 1; }

        /* === FOOTER === */
        .footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #fff; padding: 15px; box-sizing: border-box;
            border-top: 1px solid #eee; display: flex; gap: 10px; z-index: 10;
        }
        .btn-main {
            flex: 1; height: 48px; border: none; border-radius: 10px;
            font-weight: 700; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        /* Platform Specific Display */
        .ios-only, .android-only, .pc-only { display: none; }

        /* === MODAL === */
        #settings-modal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-box { background: #fff; width: 85%; max-width: 350px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        /* === PRINT STYLES === */
        #print-area { display: none; }
        @media print {
            body { background: white; height: auto; overflow: visible; display: block; }
            #app-frame { display: none; }
            #print-area { display: block; padding: 40px; width: 100%; max-width: 800px; margin: 0 auto; font-family: sans-serif; color: black; }
            
            .p-header { border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
            .p-title { font-size: 32px; font-weight: 900; margin: 0; }
            .p-date { font-size: 18px; }
            
            .p-sec { margin-bottom: 25px; }
            .p-head { font-size: 14px; font-weight: 800; border-bottom: 2px solid #ddd; margin-bottom: 5px; text-transform: uppercase; display: flex; gap: 10px; }
            .p-row { display: flex; padding: 5px 0; border-bottom: 1px dotted #ccc; font-size: 14px; }
            .p-time { width: 80px; font-weight: bold; font-family: monospace; color: #555; }
            .p-note { background: #f9f9f9; padding: 15px; border: 1px solid #ddd; white-space: pre-wrap; }
        }
    </style>
</head>
<body>

    <div id="app-frame">
        
        <div class="navbar">
            <button class="date-btn" onclick="document.getElementById('date-input').showPicker()">
                <i class="icon f7-icons" style="font-size:18px">calendar</i> 
                <span id="date-display">Today</span>
            </button>
            <input type="date" id="date-input" style="position:absolute; opacity:0; width:1px;">
            
            <div class="nav-title" id="header-title">Baby Log</div>
            
            <button class="date-btn" onclick="openSettings()" style="padding: 6px;">
                <i class="icon f7-icons" style="font-size:20px">gear_alt_fill</i>
            </button>
        </div>

        <div class="content">
            
            <div class="card">
                <div class="card-header"><i class="icon f7-icons c-blue">drop_fill</i> Formula</div>
                <div class="input-row">
                    <div class="input-box">
                        <input type="number" id="f-oz" placeholder="oz">
                        <div class="input-divider"></div>
                        <input type="time" id="f-time" class="input-time">
                    </div>
                    <button class="btn-add bg-blue" onclick="addEntry('formula')">+</button>
                </div>
                <div id="list-formula" class="list-box"></div>
            </div>

            <div class="card">
                <div class="card-header"><i class="icon f7-icons c-green">circle_fill</i> Solid Food</div>
                <div class="input-row">
                    <div class="input-box">
                        <input type="text" id="s-desc" placeholder="Description...">
                        <div class="input-divider"></div>
                        <input type="time" id="s-time" class="input-time">
                    </div>
                    <button class="btn-add bg-green" onclick="addEntry('solid')">+</button>
                </div>
                <div id="list-solid" class="list-box"></div>
            </div>

            <div class="card">
                <div class="card-header"><i class="icon f7-icons c-orange">moon_fill</i> Nap</div>
                <div class="input-row">
                    <div class="input-box">
                        <input type="time" id="n-start">
                        <span style="font-size:10px; color:#999; padding:0 5px; font-weight:bold">TO</span>
                        <input type="time" id="n-end">
                    </div>
                    <button class="btn-add bg-orange" onclick="addEntry('nap')">+</button>
                </div>
                <div id="list-nap" class="list-box"></div>
            </div>

            <div class="card">
                <div class="card-header"><i class="icon f7-icons c-pink">layers_fill</i> Diaper</div>
                <div class="input-row">
                    <div class="input-box">
                        <select id="d-type">
                            <option value="Wet">üíß Wet</option>
                            <option value="Soft">üí© Soft</option>
                            <option value="Hard">üí© Hard</option>
                            <option value="Run">üí© Run</option>
                        </select>
                        <div class="input-divider"></div>
                        <input type="time" id="d-time" class="input-time">
                    </div>
                    <button class="btn-add bg-pink" onclick="addEntry('diaper')">+</button>
                </div>
                <div id="list-diaper" class="list-box"></div>
            </div>

            <div class="card">
                <div class="card-header"><i class="icon f7-icons" style="color:#555">pencil_circle_fill</i> Notes</div>
                <div style="padding:10px;">
                    <textarea id="obs-text" style="width:100%; height:80px; border:1px solid #ddd; border-radius:8px; padding:8px; font-family:inherit; resize:none;" placeholder="Daily notes..."></textarea>
                </div>
            </div>
        </div>

        <div class="footer">
            <button class="btn-main ios-only" style="background:#111; color:white" onclick="copyToClipboard()">
                <i class="icon f7-icons">doc_on_doc</i> Copy for WhatsApp
            </button>
            <button class="btn-main android-only" style="background:#111; color:white" onclick="nativeShare()">
                <i class="icon f7-icons">share</i> Share Summary
            </button>
            <button class="btn-main pc-only" style="background:#111; color:white" onclick="printReport()">
                <i class="icon f7-icons">printer</i> Print Report
            </button>
            
            <button class="btn-main ios-only android-only" style="background:#eee; color:#333" onclick="printReport()">
                <i class="icon f7-icons">printer</i> PDF
            </button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h2 style="margin-top:0">Settings</h2>
            
            <p style="font-weight:bold; margin-bottom:5px">Platform (Choose One):</p>
            <select id="set-platform" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;" onchange="savePlatform()">
                <option value="ios">iOS (iPhone)</option>
                <option value="android">Android</option>
                <option value="pc">Computer</option>
            </select>

            <p style="font-weight:bold; margin-bottom:5px">Baby Profile:</p>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="set-profile" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:8px;"></select>
                <button class="btn-add bg-blue" onclick="newProfile()">+</button>
            </div>
            
            <button class="btn-main" style="background:#f5f5f5; color:#333; width:100%" onclick="closeSettings()">Close</button>
        </div>
    </div>

    <div id="print-area"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDiqYfep_8Myjo1oJ688hLx1UT201gzWyM",
            authDomain: "babylogapp-cb457.firebaseapp.com",
            projectId: "babylogapp-cb457",
            storageBucket: "babylogapp-cb457.firebasestorage.app",
            messagingSenderId: "436304963218",
            appId: "1:436304963218:web:18767942ac7570192e684b",
            measurementId: "G-8BQD5J0PZ8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- STATE ---
        const d = new Date();
        const today = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        
        let state = {
            baby: localStorage.getItem('activeBaby') || 'Baby',
            date: today,
            platform: localStorage.getItem('platform') || 'ios',
            profiles: JSON.parse(localStorage.getItem('profiles') || '["Baby"]'),
            logs: []
        };

        // --- INIT ---
        const ui = {
            dateIn: document.getElementById('date-input'),
            dateDisp: document.getElementById('date-display'),
            title: document.getElementById('header-title'),
            obs: document.getElementById('obs-text')
        };

        function init() {
            ui.dateIn.value = state.date;
            document.getElementById('set-platform').value = state.platform;
            updateUI();
            renderProfiles();
            setNow();
            subscribe();
        }

        function updateUI() {
            // Update Date Display
            const [y,m,d] = state.date.split('-');
            ui.dateDisp.innerText = `${m}/${d}/${y}`;
            ui.title.innerText = state.baby + " Log";

            // Update Platform Buttons
            document.querySelectorAll('.ios-only, .android-only, .pc-only').forEach(e => e.style.display = 'none');
            if(state.platform === 'ios') document.querySelectorAll('.ios-only').forEach(e => e.style.display = 'flex');
            else if(state.platform === 'android') document.querySelectorAll('.android-only').forEach(e => e.style.display = 'flex');
            else document.querySelectorAll('.pc-only').forEach(e => e.style.display = 'flex');
        }

        function setNow() {
            const time = new Date().toTimeString().substring(0,5);
            ['f-time', 's-time', 'd-time'].forEach(id => {
                const el = document.getElementById(id);
                if(!el.value) el.value = time;
            });
        }

        // --- DATE & SETTINGS HANDLERS ---
        ui.dateIn.addEventListener('change', (e) => {
            state.date = e.target.value;
            updateUI();
            subscribe(); // Reload Data
        });

        window.openSettings = () => document.getElementById('settings-modal').style.display = 'flex';
        window.closeSettings = () => document.getElementById('settings-modal').style.display = 'none';
        
        window.savePlatform = () => {
            state.platform = document.getElementById('set-platform').value;
            localStorage.setItem('platform', state.platform);
            updateUI();
        };

        function renderProfiles() {
            const sel = document.getElementById('set-profile');
            sel.innerHTML = '';
            state.profiles.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.text = p;
                if(p === state.baby) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        document.getElementById('set-profile').addEventListener('change', (e) => {
            state.baby = e.target.value;
            localStorage.setItem('activeBaby', state.baby);
            updateUI();
            subscribe();
        });

        window.newProfile = () => {
            const name = prompt("New Baby Name:");
            if(name) {
                state.profiles.push(name);
                localStorage.setItem('profiles', JSON.stringify(state.profiles));
                renderProfiles();
            }
        };

        // --- ADD ENTRY (LOGIC FIX: CLEAR & SAVE) ---
        window.addEntry = async (type) => {
            let display="", time="";

            if(type === 'formula') {
                const oz = document.getElementById('f-oz').value;
                time = document.getElementById('f-time').value;
                if(!oz || !time) return alert("Missing info");
                display = `${oz} oz`;
                document.getElementById('f-oz').value = ""; // Clear Input
            }
            else if(type === 'solid') {
                const desc = document.getElementById('s-desc').value;
                time = document.getElementById('s-time').value;
                if(!desc || !time) return alert("Missing info");
                display = desc;
                document.getElementById('s-desc').value = "";
            }
            else if(type === 'nap') {
                const s = document.getElementById('n-start').value;
                const e = document.getElementById('n-end').value;
                if(!s) return alert("Missing start");
                time = s;
                display = `${s} - ${e || '?'}`;
                document.getElementById('n-start').value = ""; document.getElementById('n-end').value = "";
            }
            else if(type === 'diaper') {
                time = document.getElementById('d-time').value;
                display = document.getElementById('d-type').value;
            }

            // Save to DB
            await addDoc(collection(db, "logs"), {
                baby: state.baby, date: state.date,
                type: type, display: display, time: time,
                timestamp: new Date()
            });
        };

        // --- AUTO SAVE NOTES ---
        ui.obs.addEventListener('blur', async () => {
            localStorage.setItem(`note_${state.baby}_${state.date}`, ui.obs.value);
        });

        // --- SYNC (SOURCE OF TRUTH) ---
        let unsubscribe;
        function subscribe() {
            if(unsubscribe) unsubscribe();
            
            // Reset Arrays/Lists
            state.logs = [];
            ['formula','solid','nap','diaper'].forEach(id => document.getElementById(`list-${id}`).innerHTML = '');
            
            // Load Note from LocalStorage
            ui.obs.value = localStorage.getItem(`note_${state.baby}_${state.date}`) || "";

            const q = query(
                collection(db, "logs"),
                where("baby", "==", state.baby),
                where("date", "==", state.date),
                orderBy("timestamp", "asc")
            );

            unsubscribe = onSnapshot(q, (snapshot) => {
                // Clear again to avoid dupes
                ['formula','solid','nap','diaper'].forEach(id => document.getElementById(`list-${id}`).innerHTML = '');
                state.logs = [];

                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    state.logs.push(d); // Save for print/share

                    if(d.type !== 'obs') {
                        const html = `
                            <div class="list-item">
                                <div><span class="item-time">${d.time}</span> <span class="item-text">${d.display}</span></div>
                                <div class="item-del" onclick="del('${docSnap.id}')">‚úï</div>
                            </div>`;
                        document.getElementById(`list-${d.type}`).innerHTML += html;
                    }
                });
            });
        }

        window.del = async (id) => {
            if(confirm("Delete entry?")) await deleteDoc(doc(db, "logs", id));
        };

        // --- PRINT ENGINE (ITERATES DATA, NOT DOM) ---
        window.printReport = () => {
            let html = `
                <div class="p-header">
                    <div class="p-title">${state.baby}</div>
                    <div class="p-date">${ui.dateDisp.innerText}</div>
                </div>
            `;

            const buildSec = (title, icon, type) => {
                const items = state.logs.filter(l => l.type === type);
                if(items.length === 0) return '';
                
                let rows = '';
                items.forEach(i => {
                    rows += `<div class="p-row"><span class="p-time">${i.time}</span> ${i.display}</div>`;
                });
                return `<div class="p-sec"><div class="p-head"><span>${icon}</span> <span>${title}</span></div>${rows}</div>`;
            };

            html += buildSec("FORMULA", "üçº", 'formula');
            html += buildSec("FOOD", "üçé", 'solid');
            html += buildSec("NAP", "üí§", 'nap');
            html += buildSec("DIAPER", "üí©", 'diaper');
            
            if(ui.obs.value) {
                html += `<div class="p-sec"><div class="p-head">üìù NOTES</div><div class="p-note">${ui.obs.value}</div></div>`;
            }

            document.getElementById('print-area').innerHTML = html;
            window.print();
        };

        // --- SHARE FUNCTIONS ---
        function getSummaryText() {
            let txt = `*${state.baby} Log - ${ui.dateDisp.innerText}*\n`;
            
            const append = (title, type) => {
                const items = state.logs.filter(l => l.type === type);
                if(items.length > 0) {
                    txt += `\n${title}\n`;
                    items.forEach(i => txt += `${i.time} - ${i.display}\n`);
                }
            };

            append("üçº Formula", 'formula');
            append("üçé Food", 'solid');
            append("üí§ Nap", 'nap');
            append("üí© Diaper", 'diaper');
            
            if(ui.obs.value) txt += `\nüìù Notes\n${ui.obs.value}`;
            return txt;
        }

        window.copyToClipboard = () => {
            navigator.clipboard.writeText(getSummaryText()).then(() => alert("Copied!"));
        };

        window.nativeShare = () => {
            const txt = getSummaryText();
            if(navigator.share) navigator.share({ title: 'Log', text: txt });
            else window.copyToClipboard();
        };

        init();

    </script>
</body>
</html>
