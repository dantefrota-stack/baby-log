<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Baby Log Professional</title>
    <style>
        /* === PROFESSIONAL THEME === */
        :root {
            --primary: #007aff;
            --success: #34c759;
            --danger: #ff3b30;
            --bg: #f2f4f8;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-light: #8e8e93;
            --border: #e5e5ea;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        /* === LAYOUT CONTAINER === */
        #app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--card-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            body { padding: 20px; display: flex; justify-content: center; }
            #app-container { 
                width: 100%; 
                border-radius: 16px; 
                height: calc(100vh - 40px); 
                overflow: hidden; 
                border: 1px solid #d1d1d6;
            }
        }

        /* === HEADER === */
        .header {
            background: #f9f9f9;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .app-title { font-size: 20px; font-weight: 800; color: var(--text-main); }
        
        .btn-icon {
            background: none; border: none; font-size: 22px; cursor: pointer; padding: 5px;
        }

        .date-control {
            background: #fff; border: 1px solid #ccc; border-radius: 8px;
            padding: 5px 10px; font-weight: 600; font-family: inherit; cursor: pointer;
        }

        /* === SCROLLABLE CONTENT === */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--bg);
        }

        /* === CARDS === */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .card-header {
            padding: 10px 15px;
            background: #fafafa;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-light);
            display: flex; align-items: center; gap: 8px;
        }

        .card-body { padding: 10px 15px; }

        /* === INPUTS === */
        .input-group {
            display: flex; gap: 8px; margin-bottom: 0;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            background: #fff;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary);
        }

        /* === BUTTONS === */
        .btn {
            padding: 0 15px;
            height: 42px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            color: white;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        
        .btn-add { background: var(--success); min-width: 70px; }
        .btn-primary { background: var(--primary); width: 100%; font-size: 16px; height: 50px; margin-bottom: 10px; }
        .btn-secondary { background: #e5e5ea; color: #000; width: 100%; font-size: 16px; height: 50px; }
        .btn-danger { background: var(--danger); }

        /* === LIST ITEMS === */
        .log-list { list-style: none; padding: 0; margin: 0; margin-top: 10px; border-top: 1px dashed #eee; }
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #f0f0f0;
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

        .item-info { font-size: 15px; color: #333; }
        .item-time { 
            font-size: 12px; font-weight: 600; color: #666; 
            background: #f2f2f7; padding: 2px 6px; border-radius: 4px; margin-right: 6px;
        }
        .btn-del {
            background: #fff0f0; color: var(--danger); border: 1px solid #ffcdd2;
            padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer;
        }

        /* === FOOTER ACTIONS === */
        .footer {
            padding: 15px;
            background: white;
            border-top: 1px solid var(--border);
        }
        
        /* Visibility classes for Platform Logic */
        .show-ios { display: none; }
        .show-android { display: none; }
        .show-pc { display: none; }

        /* === MODAL === */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 16px;
            width: 85%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-h2 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #555; }

        /* === PRINT STYLES === */
        @media print {
            body { background: white; padding: 0; display: block; }
            #app-container { box-shadow: none; border: none; height: auto; overflow: visible; max-width: 100%; }
            .header, .input-group, .btn, .footer, .btn-del, #settings-modal { display: none !important; }
            .content { overflow: visible; padding: 0; }
            .card { border: none; box-shadow: none; margin-bottom: 20px; page-break-inside: avoid; }
            .card-header { background: white; border-bottom: 2px solid #000; padding-left: 0; font-size: 16px; color: black; }
            .log-item { border-bottom: 1px solid #ccc; }
            textarea { display: none; }
            #print-notes { display: block !important; white-space: pre-wrap; padding: 10px; border: 1px solid #ccc; }
            
            /* Print Header */
            #print-header-block { display: block !important; margin-bottom: 30px; border-bottom: 3px solid black; padding-bottom: 10px; }
            .ph-title { font-size: 32px; font-weight: 900; }
            .ph-date { float: right; font-size: 18px; margin-top: 10px; }
        }
        #print-header-block, #print-notes { display: none; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div class="header">
        <input type="date" id="date-picker" class="date-control">
        <div class="app-title" id="display-name">Baby Log</div>
        <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    </div>

    <div id="print-header-block">
        <span class="ph-date" id="print-date-display"></span>
        <div class="ph-title" id="print-name-display">Baby Log</div>
    </div>

    <div class="content">
        
        <div class="card">
            <div class="card-header">üçº Formula</div>
            <div class="card-body">
                <div class="input-group">
                    <input type="number" id="f-oz" placeholder="oz" style="flex:1">
                    <input type="time" id="f-time" style="width: 100px;">
                    <button class="btn btn-add" onclick="addLog('formula')">Add</button>
                </div>
                <ul id="list-formula" class="log-list"></ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üçé Solid Food</div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" id="s-desc" placeholder="Description..." style="flex:1">
                    <input type="time" id="s-time" style="width: 100px;">
                    <button class="btn btn-add" onclick="addLog('solid')">Add</button>
                </div>
                <ul id="list-solid" class="log-list"></ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üí§ Nap</div>
            <div class="card-body">
                <div class="input-group">
                    <input type="time" id="n-start">
                    <span style="align-self:center; font-weight:bold; color:#ccc">to</span>
                    <input type="time" id="n-end">
                    <button class="btn btn-add" onclick="addLog('nap')">Add</button>
                </div>
                <ul id="list-nap" class="log-list"></ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üí© Diapers</div>
            <div class="card-body">
                <div class="input-group">
                    <select id="d-type" style="flex:1">
                        <option value="Wet">üíß Wet</option>
                        <option value="Soft">üí© Soft</option>
                        <option value="Hard">üí© Hard</option>
                        <option value="Run">üí© Run</option>
                    </select>
                    <input type="time" id="d-time" style="width: 100px;">
                    <button class="btn btn-add" onclick="addLog('diaper')">Add</button>
                </div>
                <ul id="list-diaper" class="log-list"></ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üìù Notes</div>
            <div class="card-body">
                <textarea id="obs-text" rows="4" placeholder="Daily notes..."></textarea>
                <div id="print-notes"></div>
            </div>
        </div>

    </div>

    <div class="footer">
        <button class="btn btn-primary show-ios" onclick="copySummary()">üìã Copy for WhatsApp</button>
        
        <button class="btn btn-primary show-android" onclick="shareNative()">üì≤ Share Summary</button>
        
        <button class="btn btn-primary show-pc" onclick="window.print()">üñ®Ô∏è Print Report</button>
        
        <button class="btn btn-secondary show-ios" onclick="window.print()">Print / PDF</button>
        <button class="btn btn-secondary show-android" onclick="window.print()">Print / PDF</button>
    </div>

</div>

<div id="settings-modal">
    <div class="modal-content">
        <h2 class="modal-h2">Settings</h2>
        
        <div class="form-group">
            <label class="form-label">Platform (Required for Share buttons):</label>
            <select id="set-platform" onchange="saveSettings()">
                <option value="ios">iOS (iPhone/iPad)</option>
                <option value="android">Android</option>
                <option value="pc">Computer / Desktop</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Active Profile:</label>
            <div style="display:flex; gap:5px;">
                <select id="set-profile" onchange="switchProfile()"></select>
                <button class="btn btn-add" onclick="newProfile()" style="min-width:40px;">+</button>
            </div>
        </div>
        
        <div class="form-group">
            <button class="btn btn-danger" style="width:100%" onclick="deleteProfile()">Delete Current Profile</button>
        </div>

        <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDiqYfep_8Myjo1oJ688hLx1UT201gzWyM",
        authDomain: "babylogapp-cb457.firebaseapp.com",
        projectId: "babylogapp-cb457",
        storageBucket: "babylogapp-cb457.firebasestorage.app",
        messagingSenderId: "436304963218",
        appId: "1:436304963218:web:18767942ac7570192e684b",
        measurementId: "G-8BQD5J0PZ8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- APP STATE ---
    const todayLocal = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD Local
    let state = {
        date: todayLocal,
        baby: localStorage.getItem('activeBaby') || 'Baby',
        platform: localStorage.getItem('platform') || 'ios', // Default to iOS
        profiles: JSON.parse(localStorage.getItem('profiles') || '["Baby"]'),
        logs: []
    };

    // --- INIT ---
    function init() {
        document.getElementById('date-picker').value = state.date;
        document.getElementById('set-platform').value = state.platform;
        updateUIForPlatform();
        renderProfileList();
        updateHeaders();
        
        // Set default times
        const now = new Date().toTimeString().substring(0,5);
        document.querySelectorAll('input[type="time"]').forEach(el => el.value = now);

        subscribe(); // Connect DB
        loadNotes(); // Load Drafts
    }

    // --- PLATFORM LOGIC (The User Request) ---
    window.saveSettings = () => {
        state.platform = document.getElementById('set-platform').value;
        localStorage.setItem('platform', state.platform);
        updateUIForPlatform();
    };

    function updateUIForPlatform() {
        // Hide all first
        document.querySelectorAll('.show-ios, .show-android, .show-pc').forEach(el => el.style.display = 'none');
        
        // Show relevant
        if(state.platform === 'ios') {
            document.querySelectorAll('.show-ios').forEach(el => el.style.display = 'block');
        } else if (state.platform === 'android') {
            document.querySelectorAll('.show-android').forEach(el => el.style.display = 'block');
        } else {
            document.querySelectorAll('.show-pc').forEach(el => el.style.display = 'block');
        }
    }

    // --- FIREBASE LOGIC (Unified Data) ---
    let unsubscribe;
    function subscribe() {
        if(unsubscribe) unsubscribe();
        
        // Clear visual lists immediately
        ['formula', 'solid', 'nap', 'diaper'].forEach(k => document.getElementById(`list-${k}`).innerHTML = '');
        state.logs = [];

        const q = query(
            collection(db, "logs"),
            where("baby", "==", state.baby),
            where("date", "==", state.date),
            orderBy("timestamp", "asc")
        );

        unsubscribe = onSnapshot(q, (snapshot) => {
            // Re-clear to prevent duplicates on rapid updates
            ['formula', 'solid', 'nap', 'diaper'].forEach(k => document.getElementById(`list-${k}`).innerHTML = '');
            state.logs = [];

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                state.logs.push(d); // Save for sharing

                if(d.type === 'obs') return; // Skip notes in list

                const li = document.createElement('li');
                li.className = 'log-item';
                li.innerHTML = `
                    <div>
                        <span class="item-time">${d.time}</span>
                        <span class="item-info">${d.display}</span>
                    </div>
                    <button class="btn-del" onclick="deleteLog('${docSnap.id}')">X</button>
                `;
                const list = document.getElementById(`list-${d.type}`);
                if(list) list.appendChild(li);
            });
        });
    }

    window.addLog = async (type) => {
        let display = "", time = "";

        if(type === 'formula') {
            const oz = document.getElementById('f-oz').value;
            time = document.getElementById('f-time').value;
            if(!oz) return alert("Enter Amount");
            display = `${oz} oz`;
            document.getElementById('f-oz').value = "";
        } 
        else if(type === 'solid') {
            const desc = document.getElementById('s-desc').value;
            time = document.getElementById('s-time').value;
            if(!desc) return alert("Enter Description");
            display = desc;
            document.getElementById('s-desc').value = "";
        }
        else if(type === 'nap') {
            const s = document.getElementById('n-start').value;
            const e = document.getElementById('n-end').value;
            time = s;
            display = `${s} - ${e || '?'}`;
            document.getElementById('n-start').value = ""; 
            document.getElementById('n-end').value = "";
        }
        else if(type === 'diaper') {
            time = document.getElementById('d-time').value;
            display = document.getElementById('d-type').value;
        }

        await addDoc(collection(db, "logs"), {
            baby: state.baby,
            date: state.date,
            type: type,
            display: display,
            time: time,
            timestamp: new Date()
        });
    };

    window.deleteLog = async (id) => {
        if(confirm("Delete entry?")) await deleteDoc(doc(db, "logs", id));
    };

    // --- NOTES ---
    const noteKey = () => `note_${state.baby}_${state.date}`;
    function loadNotes() {
        const txt = localStorage.getItem(noteKey()) || "";
        document.getElementById('obs-text').value = txt;
        document.getElementById('print-notes').innerText = txt;
    }
    document.getElementById('obs-text').addEventListener('input', function() {
        localStorage.setItem(noteKey(), this.value);
        document.getElementById('print-notes').innerText = this.value;
    });

    // --- SHARE GENERATORS ---
    function generateSummary() {
        let txt = `*${state.baby} Log - ${state.date}*\n`;
        const types = {formula: 'üçº Formula', solid: 'üçé Food', nap: 'üí§ Nap', diaper: 'üí© Diaper'};
        
        for(let key in types) {
            const items = state.logs.filter(l => l.type === key);
            if(items.length > 0) {
                txt += `\n${types[key]}\n`;
                items.forEach(i => txt += `${i.time} - ${i.display}\n`);
            }
        }
        
        const note = document.getElementById('obs-text').value;
        if(note) txt += `\nüìù Notes\n${note}`;
        
        return txt;
    }

    // 1. Copy (iOS Preference)
    window.copySummary = () => {
        const txt = generateSummary();
        navigator.clipboard.writeText(txt).then(() => alert("Summary Copied! Paste in WhatsApp."));
    };

    // 2. Native Share (Android Preference)
    window.shareNative = () => {
        const txt = generateSummary();
        if(navigator.share) navigator.share({ title: 'Baby Log', text: txt });
        else window.copySummary(); // Fallback
    };

    // --- PROFILE MANAGEMENT ---
    window.openSettings = () => document.getElementById('settings-modal').style.display = 'flex';
    window.closeSettings = () => document.getElementById('settings-modal').style.display = 'none';

    function renderProfileList() {
        const sel = document.getElementById('set-profile');
        sel.innerHTML = '';
        state.profiles.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.text = p;
            if(p === state.baby) opt.selected = true;
            sel.appendChild(opt);
        });
    }
    
    window.newProfile = () => {
        const name = prompt("New baby name:");
        if(name) {
            state.profiles.push(name);
            localStorage.setItem('profiles', JSON.stringify(state.profiles));
            state.baby = name;
            saveActiveProfile();
        }
    };

    window.switchProfile = () => {
        state.baby = document.getElementById('set-profile').value;
        saveActiveProfile();
    };

    window.deleteProfile = () => {
        if(state.profiles.length <= 1) return alert("Keep at least one profile");
        if(confirm(`Delete ${state.baby}?`)) {
            state.profiles = state.profiles.filter(p => p !== state.baby);
            state.baby = state.profiles[0];
            localStorage.setItem('profiles', JSON.stringify(state.profiles));
            saveActiveProfile();
        }
    };

    function saveActiveProfile() {
        localStorage.setItem('activeBaby', state.baby);
        updateHeaders();
        renderProfileList();
        subscribe();
        loadNotes();
    }

    function updateHeaders() {
        document.getElementById('display-name').innerText = state.baby + " Log";
        document.getElementById('print-name-display').innerText = state.baby + " Log";
        document.getElementById('print-date-display').innerText = state.date;
    }

    // --- DATE ---
    document.getElementById('date-picker').addEventListener('change', (e) => {
        state.date = e.target.value;
        updateHeaders();
        subscribe();
        loadNotes();
    });

    // Start
    init();

</script>
</body>
</html>